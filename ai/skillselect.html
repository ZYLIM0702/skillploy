<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skill Selector</title>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .skill-box {
      display: flex;
      flex-direction: column;
      max-width: 400px;
      margin: 20px auto;
    }

    button {
      margin-top: 10px;
      padding: 10px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:disabled {
      background-color: gray;
    }

    .error {
      color: red;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Select Your Skills</h1>
  <p>Select a minimum of 1 skill and a maximum of 5 skills.</p>
  <div class="skill-box" id="skills-container"></div>
  <button id="submit-button" disabled>Submit</button>
  <p class="error" id="error-message"></p>

  <script type="module">
    import { db } from "../firebase-config.js";
    import { collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const skillsContainer = document.getElementById('skills-container');
    const submitButton = document.getElementById('submit-button');
    const errorMessage = document.getElementById('error-message');

    let selectedSkills = [];
    const skillsMap = new Map(); // To map skill names to their Firestore document IDs
    const studentId = "4ihhCbDEFVSlVe7OHq5jKKPXtNn2";

    // Fetch skills from Firestore and render checkboxes
    const fetchSkills = async () => {
      try {
        const skillsCollection = collection(db, 'Skills');
        const snapshot = await getDocs(skillsCollection);

        if (!snapshot.empty) {
          snapshot.forEach(doc => {
            const skillName = doc.data().name; // Fetch only the 'name' field
            skillsMap.set(skillName, doc.id); // Map skill name to Firestore document ID
            createCheckbox(skillName);
          });
        } else {
          displayError('No skills available to select.');
        }
      } catch (error) {
        displayError('Error fetching skills. Please try again later.');
        console.error('Error fetching skills:', error);
      }
    };

    // Create a checkbox for each skill
    const createCheckbox = (label) => {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = label;
      checkbox.addEventListener('change', handleCheckboxChange);

      const labelElement = document.createElement('label');
      labelElement.textContent = label;

      const div = document.createElement('div');
      div.appendChild(checkbox);
      div.appendChild(labelElement);

      skillsContainer.appendChild(div);
    };

    // Handle checkbox changes
    const handleCheckboxChange = (event) => {
      const value = event.target.value;

      if (event.target.checked) {
        if (selectedSkills.length < 5) {
          selectedSkills.push(skillsMap.get(value)); // Use Firestore document ID
        } else {
          event.target.checked = false;
          displayError('You can only select up to 5 skills.');
        }
      } else {
        const idToRemove = skillsMap.get(value);
        selectedSkills = selectedSkills.filter(skillId => skillId !== idToRemove);
      }

      submitButton.disabled = selectedSkills.length < 1; // Enable if at least 1 skill selected
    };

    // Submit selected skills to Firestore
    const submitSkills = async () => {
      try {
        const studentDoc = doc(db, 'Students', studentId);
        await updateDoc(studentDoc, { selectedSkills: selectedSkills });
        alert('Skills successfully submitted!');
        resetForm();
      } catch (error) {
        displayError('Error submitting skills. Please try again.');
        console.error('Error submitting skills:', error);
      }
    };

    // Reset form after submission
    const resetForm = () => {
      selectedSkills = [];
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      submitButton.disabled = true;
    };

    // Display error messages
    const displayError = (message) => {
      errorMessage.textContent = message;
      setTimeout(() => errorMessage.textContent = '', 3000);
    };

    // Attach event listener to submit button
    submitButton.addEventListener('click', submitSkills);

    // Load skills on page load
    fetchSkills();
</script>



</body>
</html>
